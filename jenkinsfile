pipeline {
    agent any
    stages {
        stage("Build"){
            when { 
                expression { 
                    GIT_BRANCH == "main" || GIT_BRANCH == "staging"
                }
            }
            steps{
                //Habilitar variables de entorno
                sh "cp /var/lib/jenkins/Environment/WMS_Mobile .env"
                sh "docker-compose up --build"
            }
        }
        stage('Deploy'){
             when { 
                expression { 
                    GIT_BRANCH == "main" || GIT_BRANCH == "staging"
                }
            }
            environment {
                APK_VERSION = sh(
                    returnStdout: true, 
                    script: "echo \$(grep 'version:' pubspec.yaml | awk '{print \$2}')"
                ).trim()
            }
            steps{
                //Cambiar el nombre del apk a su version actual
                //sh 'mv ./apks/app-armeabi-v7a-release.apk ${APK_VERSION}.apk'
                //Enviar al servidor ftp
                sh 'scp ./apks/app-armeabi-v7a-release.apk wms1_windows:\\\\Handheld\\\\cicd\\\\development'
            }
        }
    }
}  